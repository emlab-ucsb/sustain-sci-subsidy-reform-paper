---
title: "Wrangle RAM Legacy Stock Assessment Database (v4.491)"
output: html_document
---

```{r setup, include=FALSE}
# Load packages
library(knitr) 
library(countrycode) # country name matching
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE)

# Path to raw RAM .Rdata
ram_dat_path <- "./RAM v4.491 Files (1-14-20)/RAM v4.491/DB Files With Assessment Data/R Data/DBdata[asmt][v4.491].RData"

# Load RAM data
load(ram_dat_path)

# Get region information to start assigning FAO regions
ram_stocks_spatial_areas <- stock %>%
  dplyr::select(stockid, 
                stocklong,
                areaid, 
                region) %>%
  left_join(area %>% dplyr::select(areaid, areaname, country), by = "areaid") %>%
  left_join(metadata %>% dplyr::select(stockid, primary_FAOarea), by = "stockid") %>%
  arrange(country)

```

## Assign FAO areas based on "region"

Though the RAM database now has a "primary FAO area" attribute associated with many of the entries, it's worth making our own lookup table to make sure they match up. We will also want to correct these for the multinational stocks.

We start by using the "region" attribute. For some, this will be enough to determine the relevant FAO area. For others it will not, and we will need to assign the relevant FAO area based on another arribute. 

```{r cars}
ram_fao_by_region <- ram_stocks_spatial_areas %>%
  distinct(region) %>%
  mutate(region_fao_area = case_when(region == "South America" ~ "NA", # Not sufficienct to determine FAO area
                                     region == "Australia" ~ "NA", # Not sufficienct to determine FAO area
                                     region == "Canada East Coast" ~ "21",
                                     region == "Canada West Coast" ~ "67",
                                     region == "Canada West Coast (Pacific Salmon)" ~ "2",
                                     region == "Other" ~ "NA", # Not sufficienct to determine FAO area
                                     region == "Japan" ~ "61",
                                     region == "Russia Japan (Pacific Salmon)" ~ "4",
                                     region == "Indian Ocean" ~ "NA", # Not sufficienct to determine FAO area
                                     region == "Mediterranean-Black Sea" ~ "37",
                                     region == "Atlantic Ocean" ~ "NA", # Not sufficienct to determine FAO area
                                     region == "Pacific Ocean" ~ "NA", # Not sufficienct to determine FAO area
                                     region == "European Union" ~ "NA", # Not sufficienct to determine FAO area
                                     region == "West Africa" ~ "NA", # Not sufficienct to determine FAO area
                                     region == "Europe non EU" ~ "NA", # Not sufficienct to determine FAO area
                                     region == "US Alaska" ~ "NA", # Not sufficienct to determine FAO area
                                     region == "New Zealand" ~ "81",
                                     region == "South Africa" ~ "NA", # Not sufficienct to determine FAO area
                                     region == "US East Coast" ~ "NA", # Not sufficienct to determine FAO area
                                     region == "US West Coast" ~ "NA", # Not sufficienct to determine FAO area
                                     region == "US Southeast and Gulf" ~ "31",
                                     region == "US Alaska (Pacific Salmon)" ~ "2",
                                     region == "US West Coast (Pacific Salmon)" ~ "2",
                                     TRUE ~ "NA")) %>%
  dplyr::filter(region_fao_area != "NA")
```

## Assign FAO areas based on "country"

For instances where region was not enough, we now consider country. 

```{r}
ram_fao_by_country <- ram_stocks_spatial_areas %>%
  anti_join(ram_fao_by_region, by = "region") %>%
  distinct(country) %>%
  mutate(country_fao_area = case_when(country == "Argentina" ~ "41",
                                      country == "Australia" ~ "NA", # Not sufficienct to determine FAO area
                                      country == "Chile" ~ "87",
                                      country == "Iran" ~ "4",
                                      country == "multinational" ~ "NA", # Not sufficienct to determine FAO area
                                      country == "Multinational" ~ "NA", # Not sufficienct to determine FAO area
                                      country == "Peru" ~ "87",
                                      country == "Russia" ~ "NA", # Not sufficienct to determine FAO area
                                      country == "South Africa" ~ "NA", # Not sufficienct to determine FAO area
                                      country == "USA" ~ "NA", # Not sufficienct to determine FAO area
                                      TRUE ~ "NA")) %>%
  dplyr::filter(country_fao_area != "NA")
```

## Assign FAO areas based on "areaname"

For instances where region and country were not enough, we now consider "areaname". Let's break it apart by country to make it a bit more feasible. 

```{r}
ram_fao_by_areaname_austraila <- ram_stocks_spatial_areas %>%
  anti_join(ram_fao_by_region, by = "region") %>%
  dplyr::filter(country == "Australia") %>%
  distinct(country, areaname) %>%
  mutate(areaname_fao_area = case_when(areaname == "New South Wales to Western Australia" ~ "57;81",
                                       areaname == "Southeast Australia" ~ "57;81",
                                       areaname == "Northern Australia" ~ "57;71",
                                       areaname == "Eastern half of Southeast Australia" ~ "81",
                                       areaname == "Western half of Southeast Australia" ~ "57",
                                       areaname == "Queensland and New South Wales" ~ "71;81",
                                       areaname == "Cascade Plateau" ~ "81", # might touch 57 slightly
                                       areaname == "Macquarie Island" ~ "81",
                                       areaname == "Eastern Australia" ~ "57",
                                       areaname == "South Australia Northern Zone" ~ "57",
                                       areaname == "South Australia Southern Zone" ~ "57",
                                       areaname == "Northern Spencer Gulf" ~ "57",
                                       areaname == "Southern Gulf St. Vincent" ~ "57",
                                       areaname == "Southern Spencer Gulf" ~ "57",
                                       areaname == "Tasmania" ~ "57",
                                       TRUE ~ "57;71;81"))
```

```{r}
ram_fao_by_areaname_multinational <- ram_stocks_spatial_areas %>%
  anti_join(ram_fao_by_region, by = "region") %>%
  dplyr::filter(country %in% c("multinational", "Multinational")) %>%
  distinct(country, region, areaname) %>%
  mutate(areaname_fao_area = case_when(areaname == "Chile" ~ "87",
                                       areaname == "Indian Ocean" ~ "51;57",
                                       areaname == "Northern Atlantic" ~ "NA", # Not enough info
                                       areaname == "South Atlantic" ~ "NA", # Not enough info
                                       areaname == "South Pacific Ocean	" ~ "NA", # Not enough info
                                       areaname == "Portugese Waters -East" ~ "27", 
                                       areaname == "Bay of Biscay" ~ "27",
                                       areaname == "West Africa" ~ "NA", # Not enough info
                                       areaname == "Eastern Australia" ~ "57",
                                       areaname == "South Australia Northern Zone" ~ "57",
                                       areaname == "South Australia Southern Zone" ~ "57",
                                       areaname == "Northern Spencer Gulf" ~ "57",
                                       areaname == "Southern Gulf St. Vincent" ~ "57",
                                       areaname == "Southern Spencer Gulf" ~ "57",
                                       areaname == "Tasmania" ~ "57",
                                       TRUE ~ "NA"))
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
